# =============================================================
# GitHub Actions: Build & Release autom√°tico
# =============================================================
# Se ejecuta cuando:
#   1. Se hace push de un tag con formato v* (ej: v1.0.0, v1.2.3)
#   2. Se dispara manualmente desde la pesta√±a "Actions" de GitHub
#
# Uso r√°pido:
#   git tag v1.1.0
#   git push origin v1.1.0
# =============================================================

name: Build & Release

on:
  push:
    tags:
      - "v*"          # Se activa con tags tipo v1.0.0, v2.3.1, etc.
  workflow_dispatch:   # Permite ejecuci√≥n manual desde GitHub
    inputs:
      version:
        description: "Versi√≥n a publicar (ej: 1.2.0)"
        required: true
        type: string
      release_notes:
        description: "Notas del release (opcional, se auto-generan si se deja vac√≠o)"
        required: false
        type: string

permissions:
  contents: write      # Necesario para crear Releases

jobs:
  build:
    name: Build ejecutable Windows
    runs-on: windows-latest

    steps:
      # -------------------------------------------------------
      # 1. Checkout del c√≥digo
      # -------------------------------------------------------
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # 2. Configurar Python
      # -------------------------------------------------------
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # -------------------------------------------------------
      # 3. Instalar dependencias
      # -------------------------------------------------------
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # -------------------------------------------------------
      # 4. Determinar versi√≥n
      # -------------------------------------------------------
      - name: Determinar versi√≥n
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extraer versi√≥n del tag (quitar prefijo 'v')
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Versi√≥n: $VERSION"

      # -------------------------------------------------------
      # 5. Actualizar versi√≥n en updater.py
      # -------------------------------------------------------
      - name: Actualizar versi√≥n en c√≥digo
        shell: python
        run: |
          import re
          version = "${{ steps.version.outputs.version }}"
          
          with open("updater.py", "r", encoding="utf-8") as f:
              content = f.read()
          
          content = re.sub(
              r'CURRENT_VERSION\s*=\s*"[^"]*"',
              f'CURRENT_VERSION = "{version}"',
              content
          )
          
          with open("updater.py", "w", encoding="utf-8") as f:
              f.write(content)
          
          print(f"‚úÖ Versi√≥n actualizada a {version} en updater.py")

      # -------------------------------------------------------
      # 6. Build con PyInstaller
      # -------------------------------------------------------
      - name: Compilar ejecutable
        run: |
          pyinstaller DescargadorMusica.spec
          echo "‚úÖ Ejecutable compilado"

      # -------------------------------------------------------
      # 7. Verificar que el ejecutable existe
      # -------------------------------------------------------
      - name: Verificar ejecutable
        run: |
          if (Test-Path "dist/DescargadorMusica.exe") {
            $size = (Get-Item "dist/DescargadorMusica.exe").Length / 1MB
            Write-Output "‚úÖ DescargadorMusica.exe ($([math]::Round($size, 2)) MB)"
          } else {
            Write-Error "‚ùå No se encontr√≥ el ejecutable"
            exit 1
          }

      # -------------------------------------------------------
      # 8. Crear tag si fue dispatch manual
      # -------------------------------------------------------
      - name: Crear tag (si es dispatch manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      # -------------------------------------------------------
      # 9. Crear Release en GitHub
      # -------------------------------------------------------
      - name: Crear Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Descargador de M√∫sica v${{ steps.version.outputs.version }}"
          generate_release_notes: true
          body: |
            ## üéµ Descargador de M√∫sica v${{ steps.version.outputs.version }}

            ### Instalaci√≥n
            1. Descarga **DescargadorMusica.exe** de los archivos adjuntos
            2. Ejec√∫talo directamente (no necesita instalaci√≥n)

            ${{ github.event.inputs.release_notes || '' }}

            ### Requisitos
            - Windows 10 o superior
            - Conexi√≥n a Internet

            ---
            *Build autom√°tico ¬∑ GitHub Actions*
          files: |
            dist/DescargadorMusica.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
